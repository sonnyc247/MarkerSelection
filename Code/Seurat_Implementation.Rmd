---
title: "Finding markers with Seurat"
author: "Sonny"
output: html_notebook
---
---

This notebook/script places after "Loading_AIBS_Data.Rmd". We are now finding cell subclass markers with Seurat and the AIBS data. 
As implied, we assume that Seurat (V3+) is installed.
First, we convert the data into a Seurat object

```{r, data load and prep in Seurat}

library(Seurat) #load the needed library

tome_sample_meta_filtered$query_subclass <- paste(tome_sample_meta_filtered$split_class, tome_sample_meta_filtered$split_subclass, sep="_") #generate a final set of labels for subclass by combining class labels and subclass gene labels

unique(tome_sample_meta_filtered$query_subclass) #these will be our subclasses/key cell-group identifies that we use for getting cell markers

Seu_AIBS_obj <- CreateSeuratObject(counts = AIBS_Rawcount_InEx, meta.data = tome_sample_meta_filtered) #after confirming our grouping variable, this creates the Seurat object

# check that the seurat object data matches what we provided as input:

test <- as.data.frame(Seu_AIBS_obj@assays$RNA@counts) #extracting count matrix from Seurat object
identical(test, AIBS_Rawcount_InEx) #indentical check

test <- as.data.frame(Seu_AIBS_obj@meta.data) #extracting metadata from Seurat object
test <- test[,4:length(colnames(test))] #removing extra columns made by Seurat
identical(test, tome_sample_meta_filtered) #identical test

remove(test)

# finally, we get log cpm values of the data

Seu_AIBS_obj <- NormalizeData(Seu_AIBS_obj, normalization.method = "LogNormalize", scale.factor = 1000000)

Seu_AIBS_obj[["RNA"]]@data #see our normalized data

```

We are now ready to find cell markers.
To find markers (for cell subclass), we assign the appropriate identity to the cells/samples, and calculate markers.

```{r, find markers}

Idents(Seu_AIBS_obj) <- "query_subclass" #apply/assign our identity labels of interest to cells
Seu_AIBS_markers <- FindAllMarkers(object = Seu_AIBS_obj) # if computational resources/time is not an issue, using all default settings

# if time/resources are an issue, you may need to find markers for each group separately, such as by the example code below:
Seu_AIBS_SST_markers <- FindMarkers(Seu_AIBS_obj, ident.1 = "Oligo_OPALIN") #this is not run for the generation of this notbook

```

The results (when using FindAllMarkers) are in one dataframe in a "gathered" format (a column for your queried cell group) with all marker genes. The default results also have adjusted p values ranging from 1 to 0 (or near to it).

```{r, preliminary look through results}

head(Seu_AIBS_markers) #a quick look at the format of the dataframe

#we can filter these results, such as by adjusted p-value

Seu_AIBS_markers_filtered <- Seu_AIBS_markers[Seu_AIBS_markers$p_val_adj < .05,] #p value filter

head(Seu_AIBS_markers_filtered) #sample view of top results in dataframe

```

However, the above is just a general, one-pass attempt at getting markers using default settings in Seruat. Often times, the process will need to be repeated and reinterated to fine-tune the options and cell-grouping resolution used. The below is an example of modifying some parameters to try again.

```{r, a reiteration with changed parameters}

Seu_AIBS_markers_it1 <- Seu_AIBS_markers #save away the old results

### somtimes, we might want to change the way we group our cells

Seu_AIBS_obj$it2_query_subclass <- Idents(Seu_AIBS_obj) #making a new identity variable; starting by copying the previous active idents (which was "query_subclass" at the time)

levels(Seu_AIBS_obj$it2_query_subclass)[levels(Seu_AIBS_obj$it2_query_subclass)=="Oligo_MOBP"] <- "Oligo" #collapsing the oligo groups
levels(Seu_AIBS_obj$it2_query_subclass)[levels(Seu_AIBS_obj$it2_query_subclass)=="Oligo_OPALIN"] <- "Oligo" #collapsing the oligo groups

levels(Seu_AIBS_obj$it2_query_subclass)[levels(Seu_AIBS_obj$it2_query_subclass)=="Exc_RORB"] <- "Pyramidal" #collapsing the exc groups
levels(Seu_AIBS_obj$it2_query_subclass)[levels(Seu_AIBS_obj$it2_query_subclass)=="Exc_LINC00507"] <- "Pyramidal" #collapsing the exc groups
levels(Seu_AIBS_obj$it2_query_subclass)[levels(Seu_AIBS_obj$it2_query_subclass)=="Exc_FEZF2"] <- "Pyramidal" #collapsing the exc groups
levels(Seu_AIBS_obj$it2_query_subclass)[levels(Seu_AIBS_obj$it2_query_subclass)=="Exc_THEMIS"] <- "Pyramidal" #collapsing the exc groups

Idents(Seu_AIBS_obj) <- "it2_query_subclass" #setting the active identity to the new set of identity variables

### sometimes, we might want to further filter out some cells from our analyses

Seu_AIBS_obj_it2 <- subset(Seu_AIBS_obj, idents = c("Inh_ADARB2", "Inh_LHX6"), invert = TRUE) #we want all cells except for these two groups

### now we find markers again, but we might want to change parameters

BiocManager::install("MAST") #we want to use this DE test in FindAllMarkers this time
library("MAST")

Seu_AIBS_markers_it2 <- FindAllMarkers(object = Seu_AIBS_obj_it2, slot = "data", logfc.threshold = 1, test.use = "MAST", min.pct = .7, min.diff.pct = .8, only.pos = TRUE, return.thresh = .05) #parameters based on AIBS workflow, brought to our attention by Jordan Sicherman 

# that was quick, perhaps due to stringent thresholds, can keep trying different iterations:

Seu_AIBS_markers_it3 <- FindAllMarkers(Seu_AIBS_obj_it2, logfc.threshold = 1, min.pct = .7, only.pos = TRUE, return.thresh = .05, test.use = "MAST")

Seu_AIBS_markers_it4 <- FindAllMarkers(Seu_AIBS_obj_it2, logfc.threshold = 1, min.pct = .7, only.pos = TRUE, return.thresh = .05)

```

This is the end of this notebook for now. We can now take this list of markers and evaluate them or use them for other analyses.
